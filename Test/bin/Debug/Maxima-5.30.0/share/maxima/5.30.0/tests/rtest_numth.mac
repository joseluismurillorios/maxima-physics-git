(kill(all), 0);
0;

/* (Z/pZ)* p prime */
p : 2^127-1;
170141183460469231731687303715884105727;

fs : ifactors(p - 1);
[[2, 1], [3, 3], [7, 2], [19, 1], [43, 1], [73, 1], [127, 1], [337, 1], [5419, 1], [92737, 1], [649657, 1], [77158673929, 1]];

g : zn_primroot(p, fs);
43;

zn_primroot_p(power_mod(g, 7, p), p, fs);
false;

zn_primroot_p(power_mod(g, 11, p), p, fs);
true;

is(zn_order(g, p, fs) = totient(p));
true;

is(zn_order(power_mod(g, 7, p), p, fs) = zn_order(g, p, fs));
false;

is(zn_order(power_mod(g, 11, p), p, fs) = zn_order(g, p, fs));
true;

a : power_mod(g, 1234567890, p);
151915201611216996495932583752378710518;

zn_log(a, g, p, fs);
1234567890;

/* (Z/nZ)* n composite */
n : 22;
22;

g : zn_primroot(n);
7;

zn_primroot_p(power_mod(g, 2, n), n);
false;

zn_primroot_p(power_mod(g, 3, n), n);
true;

zn_order(power_mod(g, 2, n), n);
5;

zn_order(g, n);
10;

a : power_mod(g, 8, n);
9;

zn_log(a, g, n);
8;

/* CRT */
mods : [1009, 1013, 1019];
[1009, 1013, 1019];

x : 374599943;
374599943;

rems : map(lambda([z], mod(x, z)), mods);
[621, 647, 258];

chinese(rems, mods);
374599943;

(remvalue(p,fs,g,a,n,mods,x,rems), 0);
0;

(kill(all), modulus_copy : modulus, modulus : false, 0);
0;

/* Tests adapted from contrib/gf/gf_test.mac */

gf_set_data(123127, 5, x^5+2*x+1);
gf_data(123127,5,x^5+2*x+1,x+4,28298700309333316062584407,28298700309333316062584406,[[2,1],[3,1],[11,1],[20521,1],[939391,1],[22242194743981,1]]);

gf_set_data(7, 10, x^10+5*x^2+x+5);
gf_data(7,10,x^10+5*x^2+x+5,x,282475249,282475248,[[2,4],[3,1],[11,1],[191,1],[2801,1]]);

gf_exp(gf_primitive(), gf_index(x^9+3*x^6+x^5+2*x^2+6));
x^9+3*x^6+x^5+2*x^2+6;

gf_minimal_poly(x^9+3*x^6+x^5+2*x^2+6);
z^10+5*z^9+6*z^8+5*z^6+3*z^5+4*z^4+z^3+2*z^2+4*z+3;

gf_set_data(19);
gf_data(19,1,x,2,19,18,[[2,1],[3,2]]);

gf_exp(gf_primitive(), gf_index(17));
17;

gf_set_data(10000000019);
gf_data(10000000019,1,x,2,10000000019,10000000018,[[2,1],[131,1],[521,1],[73259,1]]);

gf_exp(gf_primitive() ,gf_index(3));
3;

gf_set_data(32717, 11, x^11+x^5+x^2+x+1);
gf_data(32717,11,x^11+x^5+x^2+x+1,x+2,45973568360012658888852552517205008541393124962933,45973568360012658888852552517205008541393124962932,[[2,2],[8179,1],[20857,1],[137992422569,1],[306802352539,1],[1591410608478398621,1]]);

gf_set_data(211, 17, x^17+2*x^2+1);
gf_data(211,17,x^17+2*x^2+1,x+6,3256879871129217157345956711624826081171,3256879871129217157345956711624826081170,[[2,1],[3,1],[5,1],[7,1],[137,1],[239,1],[473657018821793557815477348357239,1]]);

gf_set_data(2, 20, x^20+x^3+x^2+x+1);
gf_data(2,20,x^20+x^3+x^2+x+1,x^2+x,1048576,1048575,[[3,1],[5,2],[11,1],[31,1],[41,1]]);

gf_exp(gf_primitive(), gf_index(x^10+1));
x^10+1;

gf_minimal_poly(x^10+1);
z^20+z^13+z^12+z^5+z^4+z^3+1;

gf_set_data(3, 91, x^91+x^35+x+1);
gf_data(3,91,x^91+x^35+x+1,x,26183890704263137277674192438430182020124347,26183890704263137277674192438430182020124346,[[2,1],[1093,1],[797161,1],[4011586307,1],[3745603812007166116831643,1]]);

/* Tests adapted from contrib/gf/gf_hard_test.mac */

gf_set_data(7, 61, x^61+x^4+1);
gf_data(7,61,x^61+x^4+1,x+3,3556153025177363557255317383565515512407041673852007,3556153025177363557255317383565515512407041673852006,[[2,1],[3,1],[367,1],[4759,1],[177237331,1],[1914662449813727660680530326064591907,1]]);

gf_set_data(197, 24, x^24-x^8+2);
gf_data(197,24,x^24+196*x^8+2,x+19,11673186598630578538556565100133681446610566511878526881,11673186598630578538556565100133681446610566511878526880,[[2,5],[3,3],[5,1],[7,2],[11,1],[13,1],[19,1],[61,1],[73,1],[211,1],[2053,1],[3217,1],[3881,1],[36013,1],[728809,1],[750457,1],[4147537,1],[10316017,1]]);

gf_set_data(5, 84, x^84+x^41+x^2+1);
gf_data(5,84,x^84+x^41+x^2+1,x^2+1,51698788284564229679463043254372678347863256931304931640625,51698788284564229679463043254372678347863256931304931640624,[[2,4],[3,2],[7,2],[13,1],[29,1],[31,1],[43,1],[127,1],[379,1],[449,1],[601,1],[2521,1],[7603,1],[19531,1],[519499,1],[234750601,1],[24587411156281,1]]);

gf_set_data(2, 102, x^102+x^29+1);
gf_data(2,102,x^102+x^29+1,x+1,5070602400912917605986812821504,5070602400912917605986812821503,[[3,2],[7,1],[103,1],[307,1],[2143,1],[2857,1],[6529,1],[11119,1],[43691,1],[131071,1]]);

gf_set_data(5, 61, x^61+x^15+1);
gf_data(5,61,x^61+x^15+1,x+4,4336808689942017736029811203479766845703125,4336808689942017736029811203479766845703124,[[2,2],[8419,1],[918585913061,1],[140194179307171898833699259,1]]);

gf_set_data(8796519617, 8, x^8+3*x^6+x+1);
gf_data(8796519617,8,x^8+3*x^6+x+1,x+9,35849822058178726610670969179311817327626124038937602048832281182665519944803841,35849822058178726610670969179311817327626124038937602048832281182665519944803840,[[2,9],[3,1],[5,1],[127,1],[181,1],[1777,1],[2777,1],[4157,1],[6353,1],[59273,1],[77347,1],[136537,1],[247853,1],[82605209,1],[97755241,1],[7210741073,1],[172484071933,1]]);

gf_set_data(3, 120, x^120+x^4-1);
gf_data(3,120,x^120+x^4+2,x^3+x^2+2,1797010299914431210413179829509605039731475627537851106401,1797010299914431210413179829509605039731475627537851106400,[[2,5],[5,2],[7,1],[11,2],[13,1],[31,1],[41,1],[61,1],[73,1],[241,1],[271,1],[1181,1],[4561,1],[6481,1],[298801,1],[26050081,1],[42521761,1],[47763361,1]]);

gf_set_data(18659817111137);
gf_data(18659817111137,1,x,3,18659817111137,18659817111136,[[2,5],[29347,1],[19869809,1]]);

gf_log(7);
15962290024269;

/* Examples adapted from contrib/gf/gf_manual.pdf */

gf_set_data(2, 4, x^4+x+1);
gf_data(2,4,x^4+x+1,x,16,15,[[3,1],[5,1]]);

(a : x^3+x^2+1, b : x^3+x+1, 0);
0;

gf_add(a, b);
x^2+x;

gf_mult(a, b);
x^2+x;

gf_inv(b);
x^2+1;

gf_div(a, b);
x^3+x^2;

gf_mult(a, gf_inv(b));
x^3+x^2;

gf_exp(a, 10);
x^2+x+1;

gf_exp(a, 15);
1;

gf_primitive();
x;

gf_index(a);
13;

ev(a = gf_exp(x, 13)), pred;
true;

(gf_make_arrays(), 0);
0;

gf_logs[10];
9;

gf_n2p(10);
x^3+x;

gf_index(x^3+x);
9;

(a : x^2+x+1, b : x^3+x^2+1, 0);
0;

gf_log(a, b);
10;

gf_primitive_p(x^3+x+1);
true;

gf_primitive_p(x^2+x);
false;

gf_order(x^2+x);
3;

gf_order(x^3+x+1);
15;

(a : x^3+x+1, 0);
0;

p : gf_minimal_poly(a);
z^4+z^3+1;

p : subst(a, z, p);
(x^3+x+1)^4+(x^3+x+1)^3+1;

gf_eval(p);
0;

gf_set_data(7, 4, x^4+3*x^3+5*x^2+6*x+2);
gf_data(7,4,x^4+3*x^3+5*x^2+6*x+2,x+4,2401,2400,[[2,5],[3,1],[5,2]]);

(char : 7, exp : 4, g : 3*x^3+3*x^2+6, 0);
0;

gf_primitive_p(g);
true;

a : makelist(gf_log(x+i, g),i, 0, 6);
[1028,1935,2054,1008,379,1780,223];

d : 1702;
1702;

ord : char^exp - 1;
2400;

c : makelist(mod(a[i] + d, ord), i, 1, 7);
[330,1237,1356,310,2081,1082,1925];

M : [1,0,1,1,0,0,1];
[1,0,1,1,0,0,1];

c : mod(sum(M[i] * c[i], i, 1, 7), ord);
1521;

r : mod(c - exp*d, ord);
1913;

u : gf_exp(g, r);
x^3+3*x^2+2*x+5;

s : u + gf_reduction();
x^4+4*x^3+8*x^2+8*x+7;

gf_factor(s);
x*(x+2)*(x+3)*(x+6);

gf_set_data(2,4,x^4+x+1);
gf_data(2,4,x^4+x+1,x,16,15,[[3,1],[5,1]]);

(M : matrix([x^3+x^2+x, x^3, x^3+x^2], [x^2, x^3+x^2+1, x^3+x+1], [x^2+x, x^3+x^2+x+1, x^2]), 0);
0;

MI : gf_matinv(M);
matrix([x^2, x^3+x^2+x+1, x^3], [x^3+x+1, x^2+x, x^3+1], [x, 0, x^3+x+1]);

gf_matmult(M, MI);
matrix([1,0,0], [0,1,0], [0,0,1]);

gf_set_data(2, 10, x^10+x^3+1);
gf_data(2,10,x^10+x^3+1,x,1024,1023,[[3,1],[11,1],[31,1]]);

pe : gf_normal();
x^7;

M : gf_normal_basis(pe);
matrix([0,0,1,0,0,0,0,0,0,0], [0,0,1,0,0,1,0,0,0,0],
       [0,1,1,0,0,1,0,0,0,0], [1,1,1,1,0,1,0,0,0,0],
       [1,0,1,1,1,0,0,1,1,0], [0,1,1,0,1,1,1,0,1,1],
       [1,1,1,0,0,1,1,1,0,0], [1,0,1,0,0,1,0,0,1,0],
       [0,0,1,0,0,0,0,1,1,0], [0,0,1,0,0,0,0,1,0,0]);

gf_normal_basis_rep(pe, M);
[0,0,0,0,0,0,0,0,0,1];

(a : x^9+x^7+x^6+x^5+x^3+x^2+x, 0);
0;

gf_normal_basis_rep(a, M);
[0,1,1,1,0,1,0,1,1,1];

gf_normal_basis_rep(gf_exp(a, 2), M);
[1,1,1,0,1,0,1,1,1,0];

gf_set_data(2, 20, x^20+x^3+1);
gf_data(2,20,x^20+x^3+1,x,1048576,1048575,[[3,1],[5,2],[11,1],[31,1],[41,1]]);

(a : x^15+x^5+1, 0);
0;

gf_index(a);
720548;

gf_exp(a, 3^12);
x^17+x^16+x^13+x^12+x^11+x^3+x^2+x;

/* some new tests */

gf_set_data(2, 12, x^12+x^3+1);
gf_data(2,12,x^12+x^3+1,x+1,4096,4095,[[3,2],[5,1],[7,1],[13,1]]);

gf_log(gf_exp(x+1, 1234));
1234;

gf_set_data(8796519617, 2, x^2+3);
gf_data(8796519617,2,x^2+3,x+9,77378757372265826689,77378757372265826688,[[2,7],[3,1],[127,1],[1777,1],[2777,1],[4157,1],[77347,1]]);

gf_log(gf_exp(x+9, 1234567890));
1234567890;

gf_set_data(2, 4);
gf_data(2,4,x^4+x+1,x,16,15,[[3,1],[5,1]]);

(prod : (z - 0), for i:1 thru 15 do prod : prod*(z - gf_exp(x,i)), gf_eval(prod));
z^16+z;

(kill(a), gf_set_data(2, 4, a^4+a+1), p : z^4+z+1, 0);
0;

map(gf_eval, divide(p, z - a));
[z^3+a*z^2+a^2*z+a^3+1, 0];

gf_set_data(13, 7,x^7+3*x+2);
gf_data(13,7,x^7+3*x+2,x,62748517,62748516,[[2,2],[3,1],[5229043,1]]);

p : 9*x^6+12*x^5+5*x^4+x^3+8*x^2+2*x;
9*x^6+12*x^5+5*x^4+x^3+8*x^2+2*x;

gf_normal_p(p);
true;

M : gf_normal_basis(p);
matrix([9,12,5,1,8,2,0],[7,1,12,5,4,2,6],[10,8,8,6,11,12,10],
       [4,5,9,8,6,11,2],[4,9,10,11,12,1,2],[2,2,3,8,6,5,8],
       [3,2,5,0,5,6,5]);

gf_normal_basis_rep(p, M);
[0,0,0,0,0,0,1];

gf_set_data(2, x^8+x^4+x^3+x+1);
gf_data(2,8,x^8+x^4+x^3+x+1,x+1,256,255,[[3,1],[5,1],[17,1]]);

M : matrix([2,3,1,1], [1,2,3,1], [1,1,2,3], [3,1,1,2]);
matrix([2,3,1,1], [1,2,3,1], [1,1,2,3], [3,1,1,2]);

MP : matrixmap(gf_n2p, M);
matrix([x,x+1,1,1], [1,x,x+1,1], [1,1,x,x+1], [x+1,1,1,x]);

MPI : gf_matinv(MP);
matrix([x^3+x^2+x, x^3+x+1,   x^3+x^2+1, x^3+1    ],
       [x^3+1,     x^3+x^2+x, x^3+x+1,   x^3+x^2+1],
       [x^3+x^2+1, x^3+1,     x^3+x^2+x, x^3+x+1  ],
       [x^3+x+1,   x^3+x^2+1, x^3+1,     x^3+x^2+x]);

matrixmap(gf_p2n, MPI);
matrix([14,11,13,9], [9,14,11,13], [13,9,14,11], [11,13,9,14]);

fs_ord : ifactors(7^4-1);
[[2,5],[3,1],[5,2]];

gf_set_data(7, 4);
gf_data(7,4,x^4+x+1,x+5,2401,2400,[[2,5],[3,1],[5,2]]);

gf_set_data(7, 4, fs_ord);
gf_data(7,4,x^4+x+1,x+5,2401,2400,[[2,5],[3,1],[5,2]]);

gf_set_data(7, x^4+x^2+3);
gf_data(7,4,x^4+x^2+3,x+1,2401,2400,[[2,5],[3,1],[5,2]]);

gf_set_data(7, 4, x^4+x^2+3);
gf_data(7,4,x^4+x^2+3,x+1,2401,2400,[[2,5],[3,1],[5,2]]);

gf_set_data(7, x^4+x^2+3, fs_ord);
gf_data(7,4,x^4+x^2+3,x+1,2401,2400,[[2,5],[3,1],[5,2]]);

gf_set_data(7, 4, x^4+x^2+3, fs_ord);
gf_data(7,4,x^4+x^2+3,x+1,2401,2400,[[2,5],[3,1],[5,2]]);

gf_set_data(2, x^8+1);
gf_data(2,8,x^8+1,false,256,128,[[2,7]]);

gf_order();
128;

gf_inv(x);
x^7;

gf_inv(x+1);
false;

gf_gcdex(x+1, gf_reduction());
[1, 0, x+1];

gf_set_data(3, x^8+1);
gf_data(3,8,x^8+1,false,6561,6400,[[2,8],[5,2]]);

gf_order();
6400;

gf_set_data(3, x^8+x+1);
gf_data(3,8,x^8+x+1,false,6561,4368,[[2,4],[3,1],[7,1],[13,1]]);

gf_order();
4368;

gf_set_data(13, x^8+2);
gf_data(13,8,x^8+2,x+2,815730721,815730720,[[2,5],[3,1],[5,1],[7,1],[17,1],[14281,1]]);

gf_get_data();
gf_data(13,8,x^8+2,x+2,815730721,815730720,[[2,5],[3,1],[5,1],[7,1],[17,1],[14281,1]]);

(a : x^7+x+1, b : x^3+3*x^2+9*x+7, 0);
0;

gf_gcd(a, b);
x^2+2*x+7;

gf_gcdex(a, b);
[7, 6*x^4+8*x^3+3*x, x^2+2*x+7];

gf_primitive_poly(7, 8);
x^8+x+3;

gf_primitive_poly_p(x^8+x+3, 7);
true;

gf_primitive_poly_p(gf_irreducible(7, 8), 7);
true;

gf_primitive_poly(2, 8);
x^8+x^4+x^3+x^2+1;

gf_primitive_poly_p(x^8+x^4+x^3+x^2+1, 2);
true;

gf_primitive_poly_p(gf_irreducible(2, 8), 2);
false;

block([count:0, end:2*3^4], 
  for n:3^4 thru end do 
    if gf_primitive_poly_p(p:gf_n2p(n, 3), 3) then count:count+1, 
  count);
8;

(remvalue(a,b,c,d,p,g,M,MI,ord,pe,r,s,u,prod,MP,MPI,fs_ord), 
  modulus : modulus_copy, 0);
0;

gf_unset();
true;
